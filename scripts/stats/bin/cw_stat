#!/usr/bin/env ruby

# Extract the correct path for loading requirements
path = __FILE__
while File.symlink?(path)
    path = File.expand_path(File.readlink(path), File.dirname(path))
end
$:.unshift(File.join(File.dirname(File.expand_path(path)), '..', 'lib'))

require 'optparse'
require 'cw_stat_collector'

# The command line tool entry point.  Responsible for:
#
# * Parsing CLI options
# * Policing option rules
# * Creating the appropriate CWStatCollector objects
# * Kicking off the stat collection
def main
  options = {
    verbose: false,
    subscribe: false,
  }

  opts = OptionParser.new do |o|
    o.banner = "Usage: cw_stat [options] <hostname> <port> [statname]"
    o.on("-v", "--[no-]verbose", "Run verbosely") do |v|
      options[:verbose] = v
    end

    o.on("-s", "--[no-]subscribe", "Stay subscribed to changes in the statistic") do |s|
      options[:subscribe] = s
    end

    o.on("-p", "--ports PORTLIST",
         "When collecting multiple stats, the ports to pull stats from as a ",
         "comma separated list (e.g. 6666,6667).  Defaults to 6666") do |p|
      options[:ports] = p.split(",").map(&:to_i)

      # to_i returns 0 if the string is not an integer.
      fail "Invalid port option specified" if options[:ports].include? 0
    end

    o.on("-h", "--help", "Show this help") do |h|
      puts o
      exit
    end
  end
  opts.parse!

  # Extract and check positional arguments.
  num_positional_args = 3
  hostname = ARGV[0]
  port = ARGV[1]
  statname = ARGV[2]

  if hostname.nil?
    puts "Error: You must specify a host to query\n\n#{opts}"
    exit 1
  end

  if port.nil?
    puts "Error: You must specify a port to query\n\n#{opts}"
    exit 2
  else
    begin
      port = Integer(port)
    rescue ArgumentError
      puts "Error: #{port} is not a valid port number\n\n#{opts}"
      exit 3
    end
  end

  begin
    if statname.nil?
      if options[:subscribe]
        puts "Subscription is only supported for single stats"
        exit 5
      end

      stat_collectors = CWStatCollector.all_collectors(hostname, port, options)
    else
      stat_collectors = [CWStatCollector.new(hostname, port, statname, options)]
    end
  rescue Exception => e
    puts "Error: #{e.message}"
    puts "Error: Terminating due to previous errors"
    exit 6
  end

  begin
    stat_collectors.each do |c|
      c.run
    end
  rescue
    # Errors should have been reported properly already, log a generic error.
    puts "Error: Terminating due to previous errors"
  end
end

main if __FILE__ == $0
